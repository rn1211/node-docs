# DO NOT MODIFY. THIS FILE IS AUTOGENERATED #

---

dist: xenial

language: minimal

services:
  - docker

.before_script: &auto_skip
- |
    if [ "false" != "$TRAVIS_PULL_REQUEST" ]; then
      TRAVIS_COMMIT_RANGE="$TRAVIS_BRANCH..$TRAVIS_PULL_REQUEST_SHA"
    fi
    if [ "default" = "$VARIANT" ]; then
      Dockerfile="$NODE_VERSION/Dockerfile"
    else
      Dockerfile="$NODE_VERSION/$VARIANT/Dockerfile"
    fi
    if [ "" = "$TRAVIS_COMMIT_RANGE" ]; then
      echo "This is a new branch"
    elif ! git diff --name-only "$TRAVIS_COMMIT_RANGE" -- &> /dev/null; then
      echo "Change range not recognized: '$TRAVIS_COMMIT_RANGE'"
    elif git diff --name-only "$TRAVIS_COMMIT_RANGE" -- | grep -Eq "^$Dockerfile$"; then
      echo "Change of $Dockerfile detected."
    else
      echo "Skip build of $Dockerfile as it's not changed."
      exit
    fi

script: ./test-build.sh $NODE_VERSION $VARIANT

stages:
  - Test
  - Build
  - name: Deploy
    if: branch = master AND type IN (push)

jobs:
  fast_finish: true

  include:
    - stage: Test
      name: .travis.yml and travis.yml.template consistency
      script:
        - ./update.sh -t
        - git diff --stat --exit-code .travis.yml

    - stage: Deploy
      before_script:
        - |
          if ! git diff --name-only "$TRAVIS_COMMIT_RANGE" -- | grep -Eq "Dockerfile$"; then
            if git diff --name-only "$TRAVIS_COMMIT_RANGE" -- | grep -Eq "^generate-stackbrew-library.sh$"; then
              if ! git diff "$TRAVIS_COMMIT_RANGE" -- generate-stackbrew-library.sh | grep -Eq '^[-+]array_[0-9]'; then
                echo "Skip deployment as none of the Dockerfiles and version tag array in generate-stackbrew-library.sh has been changed."
                exit
              fi
            else
              echo "Skip deployment as none of the Dockerfiles and generate-stackbrew-library.sh has been changed."
              exit
            fi
          fi
      script:
        - ./generate-stackbrew-pr.sh "$TRAVIS_COMMIT_RANGE"

    # Docker Build #

    - stage: Build
      before_script: *auto_skip
      name: 10 on jessie
      env:
        - NODE_VERSION="10"
        - VARIANT="jessie"

    - stage: Build
      before_script: *auto_skip
      name: 10 on jessie-slim
      env:
        - NODE_VERSION="10"
        - VARIANT="jessie-slim"

    - stage: Build
      before_script: *auto_skip
      name: 10 on stretch
      env:
        - NODE_VERSION="10"
        - VARIANT="stretch"

    - stage: Build
      before_script: *auto_skip
      name: 10 on stretch-slim
      env:
        - NODE_VERSION="10"
        - VARIANT="stretch-slim"

    - stage: Build
      before_script: *auto_skip
      name: 10 on buster
      env:
        - NODE_VERSION="10"
        - VARIANT="buster"

    - stage: Build
      before_script: *auto_skip
      name: 10 on buster-slim
      env:
        - NODE_VERSION="10"
        - VARIANT="buster-slim"

    - stage: Build
      before_script: *auto_skip
      name: 10 on alpine3.9
      env:
        - NODE_VERSION="10"
        - VARIANT="alpine3.9"

    - stage: Build
      before_script: *auto_skip
      name: 10 on alpine3.10
      env:
        - NODE_VERSION="10"
        - VARIANT="alpine3.10"

    - stage: Build
      before_script: *auto_skip
      name: 10 on alpine3.11
      env:
        - NODE_VERSION="10"
        - VARIANT="alpine3.11"

    - stage: Build
      before_script: *auto_skip
      name: 12 on stretch
      env:
        - NODE_VERSION="12"
        - VARIANT="stretch"

    - stage: Build
      before_script: *auto_skip
      name: 12 on stretch-slim
      env:
        - NODE_VERSION="12"
        - VARIANT="stretch-slim"

    - stage: Build
      before_script: *auto_skip
      name: 12 on buster
      env:
        - NODE_VERSION="12"
        - VARIANT="buster"

    - stage: Build
      before_script: *auto_skip
      name: 12 on buster-slim
      env:
        - NODE_VERSION="12"
        - VARIANT="buster-slim"

    - stage: Build
      before_script: *auto_skip
      name: 12 on alpine3.9
      env:
        - NODE_VERSION="12"
        - VARIANT="alpine3.9"

    - stage: Build
      before_script: *auto_skip
      name: 12 on alpine3.10
      env:
        - NODE_VERSION="12"
        - VARIANT="alpine3.10"

    - stage: Build
      before_script: *auto_skip
      name: 12 on alpine3.11
      env:
        - NODE_VERSION="12"
        - VARIANT="alpine3.11"

    - stage: Build
      before_script: *auto_skip
      name: 12 on alpine3.12
      env:
        - NODE_VERSION="12"
        - VARIANT="alpine3.12"

    - stage: Build
      before_script: *auto_skip
      name: 14 on stretch
      env:
        - NODE_VERSION="14"
        - VARIANT="stretch"

    - stage: Build
      before_script: *auto_skip
      name: 14 on stretch-slim
      env:
        - NODE_VERSION="14"
        - VARIANT="stretch-slim"

    - stage: Build
      before_script: *auto_skip
      name: 14 on buster
      env:
        - NODE_VERSION="14"
        - VARIANT="buster"

    - stage: Build
      before_script: *auto_skip
      name: 14 on buster-slim
      env:
        - NODE_VERSION="14"
        - VARIANT="buster-slim"

    - stage: Build
      before_script: *auto_skip
      name: 14 on alpine3.10
      env:
        - NODE_VERSION="14"
        - VARIANT="alpine3.10"

    - stage: Build
      before_script: *auto_skip
      name: 14 on alpine3.11
      env:
        - NODE_VERSION="14"
        - VARIANT="alpine3.11"

    - stage: Build
      before_script: *auto_skip
      name: 14 on alpine3.12
      env:
        - NODE_VERSION="14"
        - VARIANT="alpine3.12"
